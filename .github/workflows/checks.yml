name: Code Quality Checks

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    name: Pre-commit Checks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.5.1'

      - name: Install R pre-commit dependencies
        run: |
          Rscript -e "install.packages(c('styler', 'lintr', 'precommit'), repos='https://cloud.r-project.org')"

      - name: Setup Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1.9'

      - name: Install Julia formatter
        run: |
          julia -e 'using Pkg; Pkg.add("JuliaFormatter")'

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  spell-check:
    runs-on: ubuntu-latest
    name: Spell Check

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install aspell
        run: |
          sudo apt-get update
          sudo apt-get install -y aspell aspell-en

      - name: Check spelling
        run: |
          echo "Checking spelling in paper files..."
          if [ -f paper/.wordlist.txt ]; then
            aspell --lang=en --mode=tex --personal=./paper/.wordlist.txt list < paper/index.qmd | sort | uniq > spelling_errors.txt
          else
            aspell --lang=en --mode=tex list < paper/index.qmd | sort | uniq > spelling_errors.txt
          fi

          if [ -s spelling_errors.txt ]; then
            echo "Spelling errors found:"
            cat spelling_errors.txt
            echo "::warning file=paper/index.qmd::Potential spelling errors found. Review spelling_errors.txt"
            # Don't fail the build for spelling errors, just warn
            exit 0
          else
            echo "No spelling errors found!"
          fi

      - name: Upload spelling errors
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spelling-errors
          path: spelling_errors.txt
          if-no-files-found: ignore
